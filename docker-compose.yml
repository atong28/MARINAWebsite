version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: marina-backend
    volumes:
      # Mount source code for hot reload (development) - use :rw for write access if needed
      - ./backend/src:/app/src:rw
      # Mount data directory (read-only)
      - ./backend/data:/app/data:ro
      # Mount logs directory
      - ./logs:/app/logs:rw
    # No port mapping - only accessible internally via nginx
    environment:
      # Server configuration
      - PORT=5000
      - HOST=${BACKEND_HOST:-0.0.0.0}
      # Pixi path
      - PATH=/root/.pixi/bin:$PATH
      # Data configuration
      - DATA_DIR=/app/data
      - METADATA_PATH=/app/data/metadata.json
      # Debugging
      - PYTHONUNBUFFERED=1
      - HIGHLIGHT_DEBUG=${HIGHLIGHT_DEBUG:-false}
      - RDKIT_ENABLED=${RDKIT_ENABLED:-true}
      # Model configuration
      - MOLECULE_IMG_SIZE=${MOLECULE_IMG_SIZE:-400}
      - DEFAULT_TOP_K=${DEFAULT_TOP_K:-10}
      - MAX_TOP_K=${MAX_TOP_K:-50}
    networks:
      - marina-net
    restart: unless-stopped
    healthcheck:
      # Health check uses internal container port (5000)
      # Use pixi run to access python in the pixi environment
      test: ["CMD", "pixi", "run", "python", "-c", "import requests; requests.get('http://localhost:5000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE: /api
    container_name: marina-frontend
    volumes:
      # Export dist directory for nginx to use
      - frontend_dist:/dist:ro
    # No port mapping - only accessible internally via nginx
    networks:
      - marina-net
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: marina-nginx
    ports:
      - "${NGINX_PORT:-8002}:80"
    volumes:
      # Mount nginx configuration
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # Mount frontend static files from frontend container volume
      - frontend_dist:/usr/share/nginx/html:ro
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_started
    networks:
      - marina-net
    restart: unless-stopped

volumes:
  frontend_dist:

networks:
  marina-net:
    driver: bridge
